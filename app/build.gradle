plugins {
    id 'com.android.application'
    id 'com.google.gms.google-services'
    id 'kotlin-android'
    id 'kotlin-kapt'
    id 'dagger.hilt.android.plugin'
    id 'kotlin-parcelize'
    id 'androidx.navigation.safeargs.kotlin'
    id 'com.google.firebase.crashlytics'
}

android {
    compileSdkVersion 32
    buildToolsVersion "30.0.3"

    defaultConfig {
        applicationId "ru.iteco.fmhandroid"
        minSdkVersion 21
        targetSdkVersion 32
        versionCode 14
        versionName "1.0.0"

        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
    }

    testOptions {
        animationsDisabled = true
    }

    compileOptions {
        coreLibraryDesugaringEnabled true
        sourceCompatibility = JavaVersion.VERSION_1_8
        targetCompatibility = JavaVersion.VERSION_1_8
    }

    kotlinOptions {
        jvmTarget = '1.8'
    }

    buildFeatures {
        viewBinding true
    }

    buildTypes {
        release {
            minifyEnabled true
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
            buildConfigField "String", "BASE_URL", '"https://students.netoservices.ru/qamid-diplom-backend/"'
        }
        debug {
            buildConfigField "String", "BASE_URL", '"https://students.netoservices.ru/qamid-diplom-backend/"'
        }
    }
}

dependencies {
    def retrofit_version = "2.9.0"
    def retrofit_gson_version = "2.9.0"
    def okhttp_logging_version = "4.9.2"
    def fragment_version = "1.4.1"
    def lifecycle_version = "2.4.1"
    def room_version = '2.4.2'
    def nav_version = '2.3.5'
    def recycler_version = '1.2.1'
    def material_version = '1.5.0'
    def constraint_version = '2.1.3'
    def coroutines_version = '1.5.2'
    def hilt_version = '2.41'
    def gson_version = '2.9.0'
    def swipe_refresh_version = '1.1.0'

    implementation 'androidx.core:core-ktx:1.7.0'
    implementation 'androidx.appcompat:appcompat:1.4.1'
    implementation "androidx.swiperefreshlayout:swiperefreshlayout:$swipe_refresh_version"
    implementation "com.google.android.material:material:$material_version"
    implementation "androidx.constraintlayout:constraintlayout:$constraint_version"
    implementation "androidx.room:room-runtime:$room_version"
    kapt "androidx.room:room-compiler:$room_version"
    implementation "androidx.room:room-ktx:$room_version"
    implementation "com.squareup.retrofit2:retrofit:$retrofit_version"
    implementation "com.squareup.retrofit2:converter-gson:$retrofit_gson_version"
    implementation "com.google.code.gson:gson:$gson_version"
    implementation "com.squareup.okhttp3:logging-interceptor:$okhttp_logging_version"
    implementation "org.jetbrains.kotlinx:kotlinx-coroutines-android:$coroutines_version"
    implementation "org.jetbrains.kotlinx:kotlinx-coroutines-play-services:$coroutines_version"
    implementation "androidx.fragment:fragment-ktx:$fragment_version"
    implementation "androidx.lifecycle:lifecycle-viewmodel-ktx:$lifecycle_version"
    implementation "androidx.lifecycle:lifecycle-livedata-ktx:$lifecycle_version"
    implementation "androidx.lifecycle:lifecycle-runtime-ktx:$lifecycle_version"
    //noinspection LifecycleAnnotationProcessorWithJava8
    kapt "androidx.lifecycle:lifecycle-compiler:$lifecycle_version"
    implementation "androidx.navigation:navigation-fragment-ktx:$nav_version"
    implementation "androidx.navigation:navigation-ui-ktx:$nav_version"
    implementation "androidx.recyclerview:recyclerview:$recycler_version"
    coreLibraryDesugaring("com.android.tools:desugar_jdk_libs:1.1.5")
    implementation "com.google.dagger:hilt-android:$hilt_version"
    kapt "com.google.dagger:hilt-compiler:$hilt_version"
    implementation platform('com.google.firebase:firebase-bom:29.0.3')
    implementation 'com.google.firebase:firebase-analytics-ktx'
    implementation 'com.google.firebase:firebase-crashlytics-ktx'

    // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    testImplementation 'junit:junit:4.13.2'
    androidTestImplementation 'androidx.test.ext:junit:1.1.5'
    androidTestImplementation 'androidx.test.espresso:espresso-core:3.5.1'

    // Allure –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤
    androidTestImplementation 'io.qameta.allure:allure-kotlin-android:2.4.0'
    androidTestImplementation 'io.qameta.allure:allure-kotlin-commons:2.4.0'
    androidTestImplementation 'io.qameta.allure:allure-kotlin-model:2.4.0'
    androidTestImplementation 'io.qameta.allure:allure-kotlin-junit4:2.4.0'

    androidTestImplementation('androidx.test.espresso:espresso-core:3.5.1') {
        exclude group: 'org.hamcrest', module: 'hamcrest'
    }
}

// ==================== ALLURE –ù–ê–°–¢–†–û–ô–ö–ò ====================

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–∞–¥–∞—á—É –¥–ª—è –∑–∞–ø—É—Å–∫–∞ Android —Ç–µ—Å—Ç–æ–≤
def androidTestTask = tasks.findByName('connectedAndroidTest') ?:
        tasks.findByName('connectedDebugAndroidTest') ?:
                tasks.findByName('connectedCheck')

if (androidTestTask) {
    // –ó–∞–¥–∞—á–∞ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ Allure
    task cleanAllureResults(type: Delete) {
        delete 'build/allure-results'
        delete 'build/reports/allure-report'
    }

    // –ó–∞–¥–∞—á–∞ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–æ–≤
    task copyTestResults(type: Copy) {
        dependsOn androidTestTask
        from 'build/outputs/androidTest-results/connected'
        into 'build/allure-results'
        include '**/*.json'
        include '**/*.xml'

        doLast {
            println "‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ build/allure-results"
        }
    }

    // –ó–∞–¥–∞—á–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞ Allure
    task generateAllureReport(type: Exec) {
        dependsOn copyTestResults

        def allureResultsDir = new File(project.buildDir, "allure-results").absolutePath
        def allureReportDir = new File(project.buildDir, "reports/allure-report").absolutePath

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –û–° –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã
        if (System.getProperty('os.name').toLowerCase(Locale.ROOT).contains('windows')) {
            commandLine 'cmd', '/c', 'allure', 'generate', allureResultsDir, '-o', allureReportDir, '--clean'
        } else {
            commandLine 'allure', 'generate', allureResultsDir, '-o', allureReportDir, '--clean'
        }

        ignoreExitValue = true

        doLast {
            if (execResult.exitValue == 0) {
                println "\n" + "="*50
                println "üéâ ALLURE –û–¢–ß–ï–¢ –£–°–ü–ï–®–ù–û –°–û–ó–î–ê–ù!"
                println "üìÅ –û—Ç—á–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤: file://${allureReportDir}/index.html"
                println "="*50 + "\n"
            } else {
                println "‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç Allure. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Allure CLI:"
                println "   https://github.com/allure-framework/allure2/releases"
            }
        }
    }

    // –ó–∞–¥–∞—á–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –æ—Ç—á–µ—Ç–∞
    task openAllureReport(type: Exec) {
        dependsOn generateAllureReport

        def allureReportDir = new File(project.buildDir, "reports/allure-report").absolutePath

        if (System.getProperty('os.name').toLowerCase(Locale.ROOT).contains('windows')) {
            commandLine 'cmd', '/c', 'allure', 'open', allureReportDir
        } else {
            commandLine 'allure', 'open', allureReportDir
        }

        ignoreExitValue = true

        doLast {
            if (execResult.exitValue != 0) {
                println "‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ—Ç—á–µ—Ç. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Allure CLI"
            }
        }
    }

    // –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞
    task runAllTestsWithAllureReport {
        dependsOn cleanAllureResults, androidTestTask.name, generateAllureReport

        doLast {
            println """
            ==========================================================
            ‚úÖ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!
            
            üìä –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ—Ç—á–µ—Ç–∞ Allure:
            
            –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª –≤ –±—Ä–∞—É–∑–µ—Ä–µ:
            file://${project.buildDir.absolutePath}/reports/allure-report/index.html
            
            –ò–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Allure CLI –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
            allure open ${project.buildDir.absolutePath}/reports/allure-report
            ==========================================================
            """
        }
    }

    // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Ç–µ—Å—Ç–æ–≤
    tasks.whenTaskAdded { task ->
        if (task.name == androidTestTask.name) {
            task.dependsOn cleanAllureResults
        }
    }
} else {
    println "‚ö† Android —Ç–µ—Å—Ç–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. Allure –∑–∞–¥–∞—á–∏ –Ω–µ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã."
}

// –£–±–∏—Ä–∞–µ–º –ª—é–±—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–ª–∞–≥–∏–Ω–∞ Allure, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫
afterEvaluate {
    println "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Allure —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞"
}